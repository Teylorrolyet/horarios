<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portal Bosque ¬∑ Registro de Horarios</title>

  <!-- Manifest para PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#14532d">

  <style>
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,sans-serif;
      background:#f0f7f4 url('logo-portal-bosque.png') no-repeat center/60%;
      color:#0f172a;
      min-height:100vh;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .panel{
      background:#ffffff;
      width:100%;
      max-width:520px;
      padding:2rem;
      border-radius:14px;
      box-shadow:0 20px 40px rgba(0,0,0,.1);
    }
    h1{text-align:center;margin:.2rem 0}
    .subtitle{text-align:center;color:#64748b;margin-bottom:1rem;font-size:.9rem}
    input,button{
      width:100%;
      padding:.75rem;
      margin-bottom:.7rem;
      border-radius:8px;
      border:1px solid #cbd5f5;
      font-size:.95rem
    }
    input:focus{outline:none;border-color:#2563eb}
    button{
      background:#14532d;
      color:#fff;
      border:none;
      font-weight:600;
      cursor:pointer
    }
    button:hover{background:#166534}
    .link{background:none;color:#475569;border:none;cursor:pointer}
    .danger{color:#b91c1c}
    .hidden{display:none}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    table{width:100%;border-collapse:collapse;margin-top:1rem;font-size:.85rem}
    th,td{padding:.55rem;border-bottom:1px solid #e2e8f0;text-align:center}
    th{background:#f1f5f9}
    .total-box{
      background:#dcfce7;
      border:1px solid #86efac;
      color:#14532d;
      font-weight:700;
      text-align:center;
      margin-top:1.2rem;
      padding:1rem;
      border-radius:10px
    }
    .notice{
      background:#ecfeff;
      border:1px solid #67e8f9;
      color:#0f766e;
      font-size:.85rem;
      text-align:center;
      margin-bottom:1rem;
      padding:.6rem;
      border-radius:8px
    }
  </style>
</head>
<body>
<div class="panel">

  <!-- LOGIN -->
  <div id="auth">
    <h1>Portal Bosque</h1>
    <p class="subtitle">Registro de horarios del personal ¬∑ Maldonado, Uruguay</p>
    <div id="authNotice" class="notice hidden"></div>
    <input id="user" placeholder="Usuario" />
    <input id="pass" type="password" placeholder="Contrase√±a" />
    <button id="btnLogin">Ingresar</button>
    <button class="link" id="btnRegister">Crear usuario</button>
  </div>

  <!-- APP -->
  <div id="app" class="hidden">
    <h1 id="welcome"></h1>
    <p class="subtitle">Ingres√° los horarios manualmente</p>

    <div id="appNotice" class="notice hidden"></div>

    <input type="month" id="mes" />
    <input type="date" id="fecha" />

    <div class="grid">
      <div>
        <label style="font-size:0.75rem;color:#475569">Entrada</label>
        <input type="time" id="entrada" />
      </div>
      <div>
        <label style="font-size:0.75rem;color:#475569">Salida</label>
        <input type="time" id="salida" />
      </div>
    </div>

    <button id="btnGuardar">Guardar jornada</button>

    <table>
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Entrada</th>
          <th>Salida</th>
          <th>Horas</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="tabla"></tbody>
    </table>

    <div id="total" class="total-box"></div>

    <button id="btnShare">Compartir horario por WhatsApp</button>

    <button class="link danger" id="btnDelete">Eliminar cuenta</button>
    <div id="deleteConfirm" class="notice hidden">
      ‚ö†Ô∏è Est√°s a punto de eliminar tu cuenta. Esta acci√≥n es permanente.
      <div style="margin-top:0.5rem;display:flex;gap:0.5rem;justify-content:center">
        <button id="btnConfirmDelete" class="danger">Eliminar definitivamente</button>
        <button id="btnCancelDelete" class="link">Cancelar</button>
      </div>
    </div>

    <button class="link" id="btnLogout">Cerrar sesi√≥n</button>
  </div>
</div>

<script>
'use strict';

let currentUser = null;

// Elementos
const u = document.getElementById('user');
const p = document.getElementById('pass');
const auth = document.getElementById('auth');
const app = document.getElementById('app');
const tabla = document.getElementById('tabla');
const welcome = document.getElementById('welcome');
const fecha = document.getElementById('fecha');
const entrada = document.getElementById('entrada');
const salida = document.getElementById('salida');
const mes = document.getElementById('mes');
const total = document.getElementById('total');
const authNotice = document.getElementById('authNotice');
const appNotice = document.getElementById('appNotice');

// Fecha local Uruguay
const now = new Date();
const today = new Date(now.getTime() - now.getTimezoneOffset()*60000);
mes.value = today.toISOString().slice(0,7);
fecha.value = today.toISOString().slice(0,10);

function notice(msg){
  const el = currentUser ? appNotice : authNotice;
  el.textContent = msg;
  el.classList.remove('hidden');
  setTimeout(() => el.classList.add('hidden'), 3000);
}

// Registro / Login
function register(){
  if(!u.value || !p.value){ notice('Complet√° los datos'); return; }
  if(localStorage.getItem(u.value)){ notice('El usuario ya existe'); return; }
  localStorage.setItem(u.value, JSON.stringify({ pass: p.value, logs: [] }));
  notice('‚úÖ Cuenta creada correctamente');
}
function login(){
  const data = JSON.parse(localStorage.getItem(u.value));
  if(!data || data.pass !== p.value){ notice('Datos incorrectos'); return; }
  currentUser = u.value;
  auth.classList.add('hidden');
  app.classList.remove('hidden');
  welcome.textContent = 'Usuario: ' + currentUser;
  render();
}
function logout(){
  currentUser = null;
  app.classList.add('hidden');
  auth.classList.remove('hidden');
}

// Datos horarios
function getData(){ return JSON.parse(localStorage.getItem(currentUser)); }
function saveData(d){ localStorage.setItem(currentUser, JSON.stringify(d)); }

function guardar(){
  if(!fecha.value || !entrada.value || !salida.value) return;
  if(diff(entrada.value,salida.value) <= 0){ notice('La salida debe ser mayor que la entrada'); return; }
  const d = getData();
  d.logs.push({f:fecha.value,i:entrada.value,o:salida.value});
  saveData(d);
  entrada.value=''; salida.value='';
  render();
}

function diff(i,o){
  const [ih,im]=i.split(':').map(Number);
  const [oh,om]=o.split(':').map(Number);
  return (oh*60+om)-(ih*60+im);
}

function fmt(m){
  const h=Math.floor(m/60);
  const mm=m%60;
  return String(h).padStart(2,'0')+':'+String(mm).padStart(2,'0')+' hs';
}

function render(){
  tabla.innerHTML='';
  let tot=0,mesTot=0;
  getData().logs.forEach((l,i)=>{
    if(mes.value && !l.f.startsWith(mes.value)) return;
    const mins=diff(l.i,l.o);
    tot+=mins; mesTot+=mins;
    tabla.innerHTML+=`<tr>
      <td>${l.f}</td>
      <td>${l.i}</td>
      <td>${l.o}</td>
      <td><strong>${fmt(mins)}</strong></td>
      <td><button class="link" onclick="del(${i})">‚úï</button></td>
    </tr>`;
  });
  const name = mes.value ? new Date(mes.value+'-01').toLocaleDateString('es-ES',{month:'long',year:'numeric'}) : 'todos los meses';
  total.textContent=`Total ${name}: ${fmt(mesTot)} | General: ${fmt(tot)}`;
}

function del(i){ const d=getData(); d.logs.splice(i,1); saveData(d); render(); }

function deleteAccount(){ document.getElementById('deleteConfirm').classList.remove('hidden'); }
function confirmDelete(){ localStorage.removeItem(currentUser); currentUser=null; document.getElementById('deleteConfirm').classList.add('hidden'); logout(); notice('Cuenta eliminada correctamente'); }
function cancelDelete(){ document.getElementById('deleteConfirm').classList.add('hidden'); }

// Compartir por WhatsApp
function shareWhatsApp(){
  const d = getData();
  const phone = prompt('Ingres√° el n√∫mero de celular (con c√≥digo pa√≠s, ej: 5989XXXXXXX):');
  if(!phone) return;
  let text = `üïí *Horario Portal Bosque*\nEmpleado: ${currentUser}\nMes: ${mes.value}\n\n`;
  let totalMin = 0;
  d.logs.forEach(l=>{
    if(mes.value && !l.f.startsWith(mes.value)) return;
    const mins=diff(l.i,l.o); totalMin+=mins;
    text += `üìÖ ${l.f} | ${l.i} - ${l.o} (${fmt(mins)})\n`;
  });
  text += `\n‚úÖ Total del mes: ${fmt(totalMin)}`;
  const url=`https://wa.me/${phone}?text=`+encodeURIComponent(text);
  window.open(url,'_blank');
}

// Eventos
document.getElementById('btnLogin').onclick=login;
document.getElementById('btnRegister').onclick=register;
document.getElementById('btnGuardar').onclick=guardar;
document.getElementById('btnLogout').onclick=logout;
document.getElementById('btnDelete').onclick=deleteAccount;
document.getElementById('btnConfirmDelete').onclick=confirmDelete;
document.getElementById('btnCancelDelete').onclick=cancelDelete;
document.getElementById('btnShare').onclick=shareWhatsApp;

// Registrar Service Worker
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{
    navigator.serviceWorker.register('service-worker.js')
      .then(reg=>console.log('Service Worker registrado', reg))
      .catch(err=>console.log('Error registrando SW',err));
  });
}
</script>
</body>
</html>
